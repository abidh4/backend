<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Exam Registration</title>
<style>
  body { font-family: "Segoe UI", Arial, sans-serif; background: #f4f7fb; display: flex; flex-direction: column; align-items: center; padding: 25px; color: #333; }
  h1 { margin-bottom: 25px; color: #2c3e50; font-size: 1.8rem; font-weight: 700; }
  .top-btn { position: absolute; top: 20px; padding:10px 16px; border:none; border-radius:8px; cursor:pointer; font-weight:600; color:#fff; }
  #logoutBtn { right: 20px; background:#e74c3c; }
  #homeBtn { right: 120px; background:#3498db; }
  .card { background: #fff; padding: 25px 30px; border-radius: 14px; box-shadow: 0 6px 14px rgba(0,0,0,0.1); max-width: 520px; width: 100%; margin-bottom: 20px; text-align: center; transition: transform 0.2s; }
  .card:hover { transform: translateY(-3px); }
  button { padding: 12px 22px; margin: 8px 6px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: transform 0.2s, background 0.3s; }
  button:hover { transform: scale(1.05); }
  .exam-btn { background: #5a85a8; color: #fff; }
  .exam-btn:hover { background: #4c7494; }
  .next-btn { background: #4CAF50; color: #fff; }
  .next-btn:hover { transform: scale(1.05); }
  .download-btn { background: #1d72b8; color: #fff; }
  .download-btn:hover { background: #155a8a; }
  #historyCard { text-align: left; max-width: 520px; width: 100%; padding: 20px; border-radius: 14px; background:#fff; box-shadow: 0 6px 14px rgba(0,0,0,0.1); margin-bottom: 20px; }
  #historyList div button { margin-left: 5px; }
  select, input[type="text"] { width: 95%; padding: 12px; margin: 12px 0; border-radius: 10px; border: 1px solid #ccc; font-size: 1rem; transition: border 0.3s; }
  select:focus, input[type="text"]:focus { outline: none; border-color: #5a85a8; box-shadow: 0 0 5px rgba(90,133,168,0.5); }
  .course-list { text-align: left; margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px; }
  .course-checkbox { background: #f1f3f6; padding: 8px 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 6px; }
  .course-checkbox input[type="checkbox"] { cursor: pointer; }
  .payment-box { background: #f1f3f6; padding: 20px; border-radius: 12px; box-shadow: inset 0 0 5px rgba(0,0,0,0.1); margin-top: 15px; }
</style>
</head>
<body>

<h1>ðŸŽ“ Student Portal</h1>
<button id="homeBtn" class="top-btn">Home</button>
<button id="logoutBtn" class="top-btn">Logout</button>

<div id="studentCard" class="card"></div>

<!-- History Box -->
<div id="historyCard" class="card">
  <h3>ðŸ“œ History</h3>
  <div id="historyList">You have no history</div>
</div>

<div class="button-container" id="registerBtnContainer">
  <button id="registerExamButton" class="exam-btn">Register for Exam</button>
</div>
<div id="examOptionsCard" style="display:none;"></div>

<script>
let fetchedStudent;
let studentHistory = [];

// Load student data
async function loadStudentData() {
  try {
    const res = await fetch('/stu/g/student-profile', { credentials: 'include' });
    fetchedStudent = await res.json();
    document.getElementById("studentCard").innerHTML = `
      <h2>${fetchedStudent.studentName}</h2>
      <p><b>Department:</b> ${fetchedStudent.deptName}</p>
      <p><b>Session:</b> ${fetchedStudent.studentSession}</p>
      <p><b>Roll:</b> ${fetchedStudent.rollNumber}</p>
    `;
  } catch(e){ alert("Error loading student: "+e.message); }
}
loadStudentData();

// Logout
document.getElementById("logoutBtn").addEventListener("click", async () => {
  try {
    const res = await fetch('/stu/p/student-logout', { method: 'POST', credentials: 'include' });
    const data = await res.json();
    if(data.success){ window.location.href = data.redirect; } 
    else { alert("Logout failed: " + data.message); }
  } catch(e){ alert("Error: " + e.message); }
});

// Home
document.getElementById("homeBtn").addEventListener("click", () => {
  window.location.href = "https://abidh4.github.io/frontend/";
});

// -------------------- Exam Registration --------------------
document.getElementById("registerExamButton").addEventListener("click", showExamOptions);

function showExamOptions() {
  const container = document.getElementById("examOptionsCard");
  document.getElementById("registerBtnContainer").style.display = "none";

  container.innerHTML = `
    <div class="card">
      <h3>Select Exam Type</h3>
      <button class="next-btn" onclick="showExamForm('Semester Final')">Semester Final</button>
      <button class="next-btn" onclick="showExamForm('Improvement')">Improvement</button>
      <button class="next-btn" onclick="showExamForm('F-Removal')">F-Removal</button>
      <br><br>
      <button class="exam-btn" onclick="dismissExamCard()">Dismiss</button>
    </div>
  `;
  container.style.display = "block";
}

// Helper: check duplicates
function isDuplicateRegistration(examType, semester, selectedCourses){
  return studentHistory.some(h => 
    h.examType === examType &&
    h.semester == semester &&
    h.courses.length === selectedCourses.length &&
    h.courses.every(c => selectedCourses.includes(c))
  );
}

function updateNextButton(examType, semester, selectedCourses){
  const nextBtn = document.querySelector("#examOptionsCard .next-btn");
  if(!nextBtn) return;

  if(isDuplicateRegistration(examType, semester, selectedCourses)){
    nextBtn.disabled = true;
    nextBtn.style.background = "#ccc";
    nextBtn.textContent = "Already Registered";
  } else {
    nextBtn.disabled = false;
    nextBtn.style.background = "#4CAF50";
    nextBtn.textContent = "Next";
  }
}

function showExamForm(examType) {
  const container = document.getElementById("examOptionsCard");
  let semesterOptions = Array.from({length:8},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join("");

  if(examType === "Semester Final"){
    container.innerHTML = `
      <div class="card">
        <h3>Register for Semester Final</h3>
        <label for="semesterSelect">Select Semester:</label>
        <select id="semesterSelect"><option value="">-- Select Semester --</option>${semesterOptions}</select>
        <div id="courseContainer" class="course-list" style="display:none;">
          <p><b>Courses for selected semester:</b></p><ul id="courseList"></ul>
        </div>
        <button class="next-btn" onclick="showPaymentGateway('Semester Final')">Next</button>
        <br><br>
        <button class="exam-btn" onclick="dismissExamCard()">Dismiss</button>
      </div>
    `;

    const semesterSelect = document.getElementById("semesterSelect");
    const courseContainer = document.getElementById("courseContainer");
    const courseList = document.getElementById("courseList");

    semesterSelect.addEventListener("change", () => {
      const sem = parseInt(semesterSelect.value);
      if(!sem){ courseContainer.style.display="none"; courseList.innerHTML=""; return;}
      courseContainer.style.display="block"; courseList.innerHTML="";
      for(let i=1;i<10;i++){
        let li = document.createElement("li");
        li.textContent = `ICT-${sem}0${i}`;
        courseList.appendChild(li);
      }
      // Frontend duplicate prevention
      const allCourses = Array.from({length:9},(_,i)=>`ICT-${sem}0${i+1}`);
      updateNextButton(examType, sem, allCourses);
    });

  } else {
    container.innerHTML = `
      <div class="card">
        <h3>Register for ${examType}</h3>
        <label for="currentSemester">Select Current Semester:</label>
        <select id="currentSemester"><option value="">-- Select Semester --</option>${semesterOptions}</select>
        <div id="courseSelectContainer" class="course-list" style="display:none;"></div>
        <p><b>Payable Amount:</b> <span id="payableAmount" style="color:#e67e22">0</span></p>
        <button class="next-btn" onclick="showPaymentGateway('${examType}')">Next</button>
        <br><br>
        <button class="exam-btn" onclick="dismissExamCard()">Dismiss</button>
      </div>
    `;
    const semesterSelect = document.getElementById("currentSemester");
    const courseContainer = document.getElementById("courseSelectContainer");
    const payableEl = document.getElementById("payableAmount");
    let selectedCourses = [];

    semesterSelect.addEventListener("change", ()=>{
      const sem = parseInt(semesterSelect.value);
      selectedCourses=[]; payableEl.textContent="0";
      if(!sem){ courseContainer.style.display="none"; courseContainer.innerHTML=""; return;}
      courseContainer.style.display="flex"; courseContainer.innerHTML="";
      for(let s=1;s<=sem;s++){
        for(let i=1;i<10;i++){
          const code = `ICT-${s}0${i}`;
          const label = document.createElement("label");
          label.className="course-checkbox";
          label.innerHTML = `<input type="checkbox" value="${code}"> ${code}`;
          courseContainer.appendChild(label);
        }
      }
      const checkboxes = courseContainer.querySelectorAll("input[type='checkbox']");
      checkboxes.forEach(cb=>{
        cb.addEventListener("change", ()=>{
          if(cb.checked) selectedCourses.push(cb.value);
          else selectedCourses = selectedCourses.filter(c=>c!==cb.value);
          payableEl.textContent = selectedCourses.length>0 ? 1000 + (selectedCourses.length-1)*300 : 0;
          // Frontend duplicate check
          updateNextButton('Improvement', sem, selectedCourses);
        });
      });
    });
  }
}

function showPaymentGateway(examType){
  let semester, courses=[], payableAmount = 0;

  if(examType === "Semester Final"){
    semester = document.getElementById("semesterSelect").value;
    if(!semester){ alert("Select semester"); return;}
    for(let i=1;i<10;i++) courses.push(`ICT-${semester}0${i}`);
    payableAmount = 5000; // Fixed for Semester Final
  } else {
    semester = document.getElementById("currentSemester").value;
    if(!semester){ alert("Select at least one semester"); return;}
    const checkboxes = document.querySelectorAll("#courseSelectContainer input[type='checkbox']:checked");
    if(checkboxes.length===0){ alert("Select at least one course"); return;}
    courses = Array.from(checkboxes).map(cb=>cb.value);
    payableAmount = courses.length>0 ? 1000 + (courses.length-1)*300 : 0;
  }

  const container = document.getElementById("examOptionsCard");
  container.innerHTML = `
    <div class="card">
      <h3>Shonar-Bangla Payment Gateway</h3>
      <div class="payment-box">
        <p>Amount to pay: <b>${payableAmount}</b></p>
        <button class="next-btn" id="payNowBtn">Pay Now</button>
      </div>
      <br>
      <button class="exam-btn" onclick="dismissExamCard()">Cancel Payment</button>
    </div>
  `;

  document.getElementById("payNowBtn").addEventListener("click", ()=>{
    const dummyTxnId = "TXN"+Math.floor(Math.random()*1000000);
    alert(`Payment Successful! Transaction ID: ${dummyTxnId}`);
    submitExam(examType, semester, courses, dummyTxnId, payableAmount);
  });
}

async function submitExam(examType, semester, courses, trxID, payableAmount){
  try{
    const res = await fetch('/stu/p/register-exam',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        rollNumber: fetchedStudent.rollNumber,
        eMail: fetchedStudent.eMail,
        examType, semester, courses,
        payableAmount,
        trxID
      })
    });
    if(!res.ok) throw new Error("Failed to register request");
    await res.json();
    dismissExamCard();
    fetchHistory();
  } catch(e){ alert("Error submitting exam: " + e.message); }
}

function dismissExamCard(){
  document.getElementById("examOptionsCard").style.display="none";
  document.getElementById("registerBtnContainer").style.display="block";
}

// -------------------- History --------------------
async function fetchHistory(){
  try{
    const res = await fetch('/stu/g/show-history');
    if(res.ok){
      const data = await res.json();
      studentHistory = data;
      renderHistory(data);
    }
  } catch(e){ console.log("Failed-->", e.message); }
}

function renderHistory(history){
  const historyList = document.getElementById("historyList");
  historyList.innerHTML = "";
  if(!history || history.length===0){
    historyList.textContent = "You have no history";
    return;
  }

  history.forEach((h, index)=>{
    const div = document.createElement("div"); 
    div.style.marginBottom="8px";
    if(h.examType !== "Semester Final"){
      div.innerHTML = `<b>${h.examType} - Semester ${h.semester} - ${h.courses}</b>`;
    } else {
      div.innerHTML = `<b>${h.examType} - Semester ${h.semester} - All Courses of ${h.semester}th Semester &nbsp;</b>`;
    }
    
    if(h.pdfBase64){
      const downloadBtn = document.createElement("button");
      downloadBtn.className = "download-btn"; downloadBtn.textContent="Download";
      downloadBtn.addEventListener("click", ()=>downloadPDF(h.pdfBase64));
      div.appendChild(downloadBtn);
    }

    if(h.canDelete){
      const deleteBtn = document.createElement("button");
      deleteBtn.className = "exam-btn"; deleteBtn.textContent="Delete";
      deleteBtn.style.marginLeft="6px";
      deleteBtn.addEventListener("click", async ()=>{
        try{
          await fetch(`/exam-admin/p/delete-history/${index}`, { method:'DELETE', credentials:'include' });
          fetchHistory(); 
        } catch(e){ console.log("Delete error:", e.message);}
      });
      div.appendChild(deleteBtn);
    }

    historyList.appendChild(div);
  });
}

function downloadPDF(base64){
  const link = document.createElement("a");
  link.href = `data:application/pdf;base64,${base64}`;
  link.download = "exam_registration.pdf";
  link.click();
}

// Poll every 3 seconds
setInterval(fetchHistory, 3000);
fetchHistory();
</script>
</body>
</html>
